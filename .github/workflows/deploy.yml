name: Deploy to IC Mainnet

on:
  push:
    branches:
      - main
    paths-ignore:
      - 'README.md'
      - 'PLAN.md'
      - 'docs/**'
      - '**/*.md'
  pull_request:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install DFX via dfxvm
        run: |
          DFXVM_VERSION="1.0.1"
          DFXVM_DIR="$HOME/.local/share/dfx"
          mkdir -p "$DFXVM_DIR/bin"

          curl -L "https://github.com/dfinity/dfxvm/releases/download/v${DFXVM_VERSION}/dfxvm-x86_64-unknown-linux-gnu.tar.gz" -o dfxvm.tar.gz
          tar -xzf dfxvm.tar.gz
          mv dfxvm-x86_64-unknown-linux-gnu/dfxvm "$DFXVM_DIR/bin/"
          chmod +x "$DFXVM_DIR/bin/dfxvm"

          echo "$DFXVM_DIR/bin" >> $GITHUB_PATH
          export PATH="$DFXVM_DIR/bin:$PATH"

          dfxvm default 0.24.3
          export PATH="$HOME/.local/share/dfx/versions/0.24.3:$PATH"
          $HOME/.local/share/dfx/versions/0.24.3/dfx --version

      - name: Import DFX Identity
        run: |
          export PATH="$HOME/.local/share/dfx/versions/0.24.3:$PATH"
          echo "${{ secrets.DFX_IDENTITY_INTURIOUS }}" > identity.pem
          dfx identity import inturious identity.pem --disable-encryption || true
          dfx identity use inturious

      - name: Deploy to IC
        env:
          DFX_NETWORK: ic
        run: |
          export PATH="$HOME/.local/share/dfx/versions/0.24.3:$PATH"
          dfx identity use inturious
          dfx deploy --network ic --yes

      - name: Deployment Summary
        run: |
          echo "âœ… Deployment Complete!"
          echo "Canister ID: ${{ vars.PRODUCTION_CANISTER_ID }}"
          echo "URL: https://${{ vars.PRODUCTION_CANISTER_ID }}.icp0.io"
